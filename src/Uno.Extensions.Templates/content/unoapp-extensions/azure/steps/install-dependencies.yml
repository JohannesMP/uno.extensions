parameters:
  #The platform to install dependencies for. #See available values at https://platform.uno/docs/articles/external/uno.check/doc/using-uno-check.html
  # For GTK depending on which OS you are planning to use, supported values are skiagtk_macos and skiagtk_win 
- name: target_platform
  type: string
  default: ''  
- name: dotnet_version
  type: string
  default: '$ciTargetDotNetVersion$.x'
- name: unocheck_manifest
  type: string
  default: 'https://raw.githubusercontent.com/unoplatform/uno.check/main/manifests/uno.ui.manifest.json'

steps:
    - checkout: self
      fetchDepth: 0
      
    - task: UseDotNet@2
      displayName: 'Use DotNet ${{ parameters.dotnet_version }}'
      inputs:
        version: '${{ parameters.dotnet_version }}'

    #Currently Uno Check fails when targetting linux on macOS/win so we are adding the references manually
    - ${{ if eq( parameters['target_platform'], 'linux') }}:
      - task: Bash@3
        displayName: 'Install Linux Workloads'
        retryCountOnTaskFailure: 3
        inputs:
          targetType: 'inline'
          script: |
              dotnet tool install -g uno.check
              ~/.dotnet/tools/uno-check --ci --non-interactive --fix --target ios --target android --target macos --manifest ${{ parameters.unocheck_manifest }}

    - ${{ else }}:
      - task: PowerShell@2
        displayName: 'Install ${{ parameters.target_platform }} Workloads'
        retryCountOnTaskFailure: 3
        inputs:
          targetType: 'inline'
          script: |
              dotnet tool install -g uno.check
              uno-check --ci --non-interactive --fix --target ${{ parameters.target_platform }} --manifest ${{ parameters.unocheck_manifest }}